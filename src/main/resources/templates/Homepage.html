<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Homepage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center">Real-Time Chat Application</h1>

    <!-- 🟦 Create Group Button -->
    <div class="text-end mb-3">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#groupModal" onclick="prepareGroupModal()">Create Group</button>
    </div>

    <h4>Groups You Are In...</h4>
    <div id="groupList" class="list-group mb-4"></div>

    <h4>Friends To Chat...</h4>
    <div id="userList" class="list-group mb-4"></div>
</div>

<!-- ✅ Bootstrap Modal for Group Creation -->
<div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="groupModalLabel">Create Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="groupUserList" class="mb-3"></div>
                <input type="text" id="groupNameInput" class="form-control mb-3" placeholder="Enter group name" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="createGroup()">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUserId = null;
    let currentUsername = null;
    let allUsers = [];

    window.onload = function () {
        fetch("http://localhost:8080/chat-app/current-user")
            .then(response => response.json())
            .then(currentUser => {
                currentUserId = currentUser.userId;
                currentUsername = currentUser.username;

                // Fetch all users
                fetch("http://localhost:8080/chat-app/users")
                    .then(response => response.json())
                    .then(users => {
                        allUsers = users;
                        const userList = document.getElementById("userList");
                        users.forEach(user => {
                            if (user.userId !== currentUserId) {
                                const userItem = document.createElement("button");
                                userItem.className = "list-group-item list-group-item-action";
                                userItem.textContent = user.username;
                                userItem.onclick = () => {
                                    localStorage.setItem("chatParticipants", JSON.stringify([currentUserId, user.userId]));
                                    localStorage.setItem("groupName", ""); // Private chat = no group
                                    window.location.href = `private-chat?currentUserId=${currentUserId}&currentUsername=${encodeURIComponent(currentUsername)}&chatMemberName=${encodeURIComponent(user.username)}`;
                                };
                                userList.appendChild(userItem);
                            }
                        });
                    });

                // 🔁 Fetch groups the user is in
                fetch(`http://localhost:8080/chat-app/groups/${currentUserId}`)
                    .then(response => response.json())
                    .then(groups => {
                        const groupListDiv = document.getElementById("groupList");
                        groups.forEach(group => {
                            const groupItem = document.createElement("button");
                            groupItem.className = "list-group-item list-group-item-action";
                            groupItem.textContent = group.groupName;

                            groupItem.onclick = () => {
                                localStorage.setItem("chatParticipants", JSON.stringify(group.memberList));
                                localStorage.setItem("groupName", group.groupName);
                                window.location.href = `private-chat?currentUserId=${currentUserId}&currentUsername=${encodeURIComponent(currentUsername)}`;
                            };

                            groupListDiv.appendChild(groupItem);
                        });
                    });
        });
    };


    // 🟩 Prepare group modal
    function prepareGroupModal() {
        const groupUserList = document.getElementById("groupUserList");
        groupUserList.innerHTML = "";
        allUsers.forEach(user => {
            if (user.userId !== currentUserId) {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = user.userId;
                checkbox.id = `user-${user.userId}`;
                checkbox.className = "form-check-input me-2";

                const label = document.createElement("label");
                label.className = "form-check-label me-3";
                label.textContent = user.username;
                label.htmlFor = checkbox.id;

                const wrapper = document.createElement("div");
                wrapper.className = "form-check mb-2";
                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);

                groupUserList.appendChild(wrapper);
            }
        });

        // Clear previous group name
        document.getElementById("groupNameInput").value = "";
    }

    // ✅ Create group and redirect
    function createGroup() {
        const groupName = document.getElementById("groupNameInput").value.trim();
        if (!groupName) return alert("Group name is required.");

        const selected = Array.from(document.querySelectorAll("#groupUserList input:checked")).map(c => c.value);
        if (selected.length === 0) return alert("Select at least one member.");

        const groupMembers = [currentUserId, ...selected];
        localStorage.setItem("chatParticipants", JSON.stringify(groupMembers));
        localStorage.setItem("groupName", groupName);
        const modal = bootstrap.Modal.getInstance(document.getElementById('groupModal'));
        modal.hide(); // Manually close the modal
        window.location.href = `private-chat?currentUserId=${currentUserId}&currentUsername=${encodeURIComponent(currentUsername)}`;
    }
</script>

<!-- ✅ Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
