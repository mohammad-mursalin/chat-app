<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Homepage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            overflow-x: hidden;
        }
        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background-color: #343a40;
            color: #fff;
            padding: 1rem;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .sidebar.collapsed {
            margin-left: -250px;
        }
        .sidebar h4 {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }
        .sidebar .logout-btn {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            width: 90%;
        }
        .content {
            margin-left: 250px;
            transition: all 0.3s ease;
            padding: 2rem;
        }
        .content.expanded {
            margin-left: 0;
        }
    </style>
</head>
<body>

<div id="sidebar" class="sidebar">
    <!-- Fixed Toggle Button -->
<button id="sidebarToggleBtn" class="btn btn-light position-fixed top-0 start-0 m-2 z-3" onclick="toggleSidebar()">â˜°</button><br><br>
    <h4 id="sidebarUsername">User</h4>
    <button class="btn btn-danger logout-btn" onclick="logout()">Logout</button>
</div>

<div id="mainContent" class="content">
    <h1 class="text-center">Real-Time Chat Application</h1>

    <div class="text-end mb-3">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#groupModal" onclick="prepareGroupModal()">Create Group</button>
    </div>

    <h4>Groups You Are In...</h4>
    <div id="groupList" class="list-group mb-4"></div>

    <h4>Friends To Chat...</h4>
    <div id="userList" class="list-group mb-4"></div>
</div>

<!-- Group Creation Modal -->
<div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="groupModalLabel">Create Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="groupUserList" class="mb-3"></div>
                <input type="text" id="groupNameInput" class="form-control mb-3" placeholder="Enter group name" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="createGroup()">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUserId = null;
    let currentUsername = null;
    let allUsers = [];

    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        sidebar.classList.toggle("collapsed");
        mainContent.classList.toggle("expanded");
    }

    function logout() {
        localStorage.clear();
        window.location.href = "/logout";
    }

    window.onload = function () {
        fetch("http://localhost:8080/chat-app/current-user")
            .then(response => response.json())
            .then(currentUser => {
                currentUserId = currentUser.userId;
                currentUsername = currentUser.username;
                document.getElementById("sidebarUsername").innerText = currentUsername;

                fetch("http://localhost:8080/chat-app/users")
                    .then(response => response.json())
                    .then(users => {
                        allUsers = users;
                        const userList = document.getElementById("userList");
                        users.forEach(user => {
                            if (user.userId !== currentUserId) {
                                const userItem = document.createElement("button");
                                userItem.className = "list-group-item list-group-item-action";
                                userItem.textContent = user.username;
                                userItem.onclick = () => {
                                    localStorage.setItem("chatParticipants", JSON.stringify([currentUserId, user.userId]));
                                    localStorage.setItem("groupName", "");
                                    window.location.href = `private-chat?currentUserId=${currentUserId}&currentUsername=${encodeURIComponent(currentUsername)}&chatMemberName=${encodeURIComponent(user.username)}`;
                                };
                                userList.appendChild(userItem);
                            }
                        });
                    });

                fetch(`http://localhost:8080/chat-app/groups/${currentUserId}`)
                    .then(response => response.json())
                    .then(groups => {
                        const groupListDiv = document.getElementById("groupList");
                        groups.forEach(group => {
                            const groupItem = document.createElement("button");
                            groupItem.className = "list-group-item list-group-item-action";
                            groupItem.textContent = group.groupName;
                            groupItem.onclick = () => {
                                localStorage.setItem("chatParticipants", JSON.stringify(group.memberList));
                                localStorage.setItem("groupName", group.groupName);
                                window.location.href = `private-chat?currentUserId=${currentUserId}&currentUsername=${encodeURIComponent(currentUsername)}`;
                            };
                            groupListDiv.appendChild(groupItem);
                        });
                    });
            });
    };

    function prepareGroupModal() {
        const groupUserList = document.getElementById("groupUserList");
        groupUserList.innerHTML = "";
        allUsers.forEach(user => {
            if (user.userId !== currentUserId) {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = user.userId;
                checkbox.id = `user-${user.userId}`;
                checkbox.className = "form-check-input me-2";

                const label = document.createElement("label");
                label.className = "form-check-label me-3";
                label.textContent = user.username;
                label.htmlFor = checkbox.id;

                const wrapper = document.createElement("div");
                wrapper.className = "form-check mb-2";
                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);

                groupUserList.appendChild(wrapper);
            }
        });

        document.getElementById("groupNameInput").value = "";
    }

    function createGroup() {
        const groupName = document.getElementById("groupNameInput").value.trim();
        if (!groupName) return alert("Group name is required.");
        const selected = Array.from(document.querySelectorAll("#groupUserList input:checked")).map(c => c.value);
        if (selected.length === 0) return alert("Select at least one member.");

        const groupMembers = [currentUserId, ...selected];
        localStorage.setItem("chatParticipants", JSON.stringify(groupMembers));
        localStorage.setItem("groupName", groupName);

        const modal = bootstrap.Modal.getInstance(document.getElementById('groupModal'));
        modal.hide();
        window.location.href = `private-chat?currentUserId=${currentUserId}&currentUsername=${encodeURIComponent(currentUsername)}`;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
